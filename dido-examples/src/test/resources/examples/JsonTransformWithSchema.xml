<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<oddjob id="oddjob">
    <job>
        <sequential>
            <jobs>
                <variables id="ourVars">
                    <ourSchema>
                        <dido:schema xmlns:dido="oddjob:dido">
                            <of>
                                <dido:field name="Fruit" type="java.lang.String"/>
                                <dido:field name="Colour" type="java.lang.String"/>
                                <dido:field name="Qty" type="int"/>
                                <dido:field name="Price" type="double"/>
                            </of>
                        </dido:schema>
                    </ourSchema>
                </variables>
                <script id="js" name="Define Conversion Provider"><![CDATA[
function toDate(s) { 
	return Java.type("java.time.LocalDate")
		.parse(s) 
}

function fromDate(d) { 
	return d.format(Java.type("java.time.format.DateTimeFormatter")
		.ofPattern("yyyyMMdd")) 
}

var conversionProvider = 
	Java.type("dido.how.conversion.DefaultConversionProvider").with()
                .conversion(java.lang.String.class, Java.type("java.time.LocalDate").class, toDate)
                .conversion(Java.type("java.time.LocalDate").class, java.lang.String.class, fromDate)
                .make();]]></script>
                <bus:bus xmlns:bus="oddjob:beanbus">
                    <of>
                        <dido:data-in xmlns:dido="oddjob:dido">
                            <how>
                                <dido:json format="LINES">
                                    <schema>
                                        <value value="${ourVars.ourSchema}"/>
                                    </schema>
                                    <conversionProvider>
                                        <value value="${js.variable(conversionProvider)}"/>
                                    </conversionProvider>
                                    <didoConversion>
                                        <value key="java.lang.String" value="java.time.LocalDate"/>
                                    </didoConversion>
                                </dido:json>
                            </how>
                            <from>
                                <file file="${oddjob.dir}/../data/FruitElementsRandom.jsonl"/>
                            </from>
                        </dido:data-in>
                        <bus:map>
                            <function>
                                <dido:transform withExisting="true" xmlns:dido="oddjob:dido">
                                    <of>
                                        <dido:remove field="Colour"/>
                                        <dido:copy field="Price" to="MarkupPrice">
                                            <type>
                                                <class name="double"/>
                                            </type>
                                            <function>
                                                <value value="#{function(x) { return x * 1.5 } }"/>
                                            </function>
                                        </dido:copy>
                                        <dido:set field="BestBefore">
                                            <value>
                                                <value value="2025-12-15"/>
                                            </value>
                                            <type>
                                                <class name="java.time.LocalDate"/>
                                            </type>
                                            <conversionProvider>
                                                <value value="${js.variable(conversionProvider)}"/>
                                            </conversionProvider>
                                        </dido:set>
                                    </of>
                                </dido:transform>
                            </function>
                        </bus:map>
                        <dido:data-out xmlns:dido="oddjob:dido">
                            <how>
                                <dido:json>
                                    <conversionProvider>
                                        <value value="${js.variable(conversionProvider)}"/>
                                    </conversionProvider>
                                    <didoConversion>
                                        <value key="java.time.LocalDate" value="java.lang.String"/>
                                    </didoConversion>
                                </dido:json>
                            </how>
                            <to>
                                <stdout/>
                            </to>
                        </dido:data-out>
                    </of>
                </bus:bus>
            </jobs>
        </sequential>
    </job>
</oddjob>
